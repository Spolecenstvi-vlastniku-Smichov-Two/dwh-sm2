<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Data Explorer</title>
    <base href="/dwh-sm2/datex/">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apache-arrow@14.0.0/+esm" type="module"></script>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <h1 id="header-title"></h1>
            <p id="header-subtitle"></p>
        </div>
        <div class="header-right" id="header-actions">
            <!-- Tlačítka se generují dynamicky -->
        </div>
    </div>

    <div class="container">
        <!-- Filtry - Časové ovládání -->
        <div class="controls" id="time-controls-panel">
            <!-- Generuje se dynamicky z DATASET_CONFIG.ui.timeControls -->
        </div>

        <!-- Filtry - Data filters -->
        <div class="controls" id="data-filters-panel">
            <!-- Generuje se dynamicky z DATASET_CONFIG.filters -->
        </div>

        <!-- Hlavní graf -->
        <div class="chart-container">
            <canvas id="mainChart"></canvas>
        </div>
    </div>

    <!-- Parquet-WASM + Chart.js -->
    <script type="module">
        import { parquetRead } from 'https://cdn.jsdelivr.net/npm/hyparquet@1.0.0/+esm';

        // Dynamicky načti config podle jazyka z URL
        let DATASET_CONFIG, ConfigHelpers;

        async function loadConfig() {
            const urlParams = new URLSearchParams(window.location.search);
            const lang = urlParams.get('lang') || 'cz'; // Default = cz

            const configPath = lang === 'en' ? './config_en.js' : './config.js';
            const module = await import(configPath);
            DATASET_CONFIG = module.DATASET_CONFIG;
            ConfigHelpers = module.ConfigHelpers;

            console.log('✅ Config loaded:', DATASET_CONFIG.name, '(lang=' + lang + ')');

            // Pokračuj v inicializaci
            initApp();
        }

        // Hlavní inicializační funkce
        function initApp() {
        // ===== FUNKCE PRO ZMĚNU JAZYKA =====
        function changeLanguage(lang) {
            const url = new URL(window.location.href);
            url.searchParams.set('lang', lang);
            window.location.href = url.toString();
        }

        // ===== STAVOVÝ SYSTÉM =====
        // Generický stav pro všechny filtry
        const filterState = {
            // Location levels - { section: Set([1,2,3]), floor: Set(['1NP', '2PP']) }
            location: initializeLocationState(),
            // Sources - { Atrea: true, ThermoPro: Set(['1NP', '2PP']) }
            sources: initializeSourceState()
        };

        function initializeLocationState() {
            const state = {};
            const globalLevels = DATASET_CONFIG.locationHierarchy?.global || [];

            globalLevels.forEach(level => {
                const defaultValues = Array.isArray(level.default) ? level.default : [];
                state[level.key] = new Set(defaultValues);
            });

            return state;
        }

        function initializeSourceState() {
            const state = {};
            const sources = DATASET_CONFIG.sources || {};

            Object.entries(sources).forEach(([key, config]) => {
                if (!config.floors) {
                    // Simple source - boolean
                    state[key] = config.default ?? false;
                } else {
                    // Hierarchical source - Set
                    state[key] = new Set();
                }
            });

            return state;
        }

        // ===== LOCATION STATE HELPERS =====
        function updateLocationState(levelKey, value, checked, scope) {
            if (scope === 'global') {
                if (!filterState.location[levelKey]) {
                    filterState.location[levelKey] = new Set();
                }
                if (checked) {
                    filterState.location[levelKey].add(value);
                } else {
                    filterState.location[levelKey].delete(value);
                }
            } else {
                // Source-specific location levels (např. podlaží pro ThermoPro)
                // Ukládáme přímo do filterState.sources[sourceKey] jako Set
                if (!filterState.sources[scope]) {
                    filterState.sources[scope] = new Set();
                }
                if (checked) {
                    filterState.sources[scope].add(value);
                } else {
                    filterState.sources[scope].delete(value);
                }
            }
        }

        function getSelectedLocationValues(levelKey) {
            return filterState.location[levelKey] || new Set();
        }

        function isLocationValueSelected(levelKey, value) {
            const selected = filterState.location[levelKey];
            return selected ? selected.has(value) : false;
        }

        // ===== SOURCE STATE HELPERS =====
        function getSourceState(sourceKey) {
            return filterState.sources[sourceKey];
        }

        function setSourceState(sourceKey, value) {
            filterState.sources[sourceKey] = value;
        }

        function isSourceSelected(sourceKey) {
            const state = getSourceState(sourceKey);
            // Pro boolean (Atrea) vrátím hodnotu přímo
            if (typeof state === 'boolean') return state;
            // Pro Set (ThermoPro floors) vrátím true, když je vybráno alespoň jedna hodnota
            if (state instanceof Set) return state.size > 0;
            return false;
        }

        function getSourceItems(sourceKey) {
            const state = getSourceState(sourceKey);
            return state instanceof Set ? state : null;
        }

        // ===== DATA =====
        let rawData = null;
        let chart = null;
        let currentData = [];

        // Barvy pro různé lokace - z configu
        const colors = DATASET_CONFIG.chart.colors;

        function getColor(index) {
            return colors[index % colors.length];
        }

        // ===== URL STATE MANAGEMENT =====
        // Ukládá a načítá stav filtrů do/z URL pro sdílení

        // Získá aktuální stav všech filtrů z DOM
        function getFilterState() {
            const state = {};

            // Metriky
            const metricCheckboxes = document.querySelectorAll('.metric-cb:checked');
            state.metrics = Array.from(metricCheckboxes).map(cb => cb.value);

            // Sekce (globální location level)
            const sectionCheckboxes = document.querySelectorAll('input[type="checkbox"][data-level="section"]:checked');
            state.sections = Array.from(sectionCheckboxes).map(cb => cb.value);

            // Zdroje a podlaží
            const sources = DATASET_CONFIG.sources || {};
            state.sources = [];
            state.floors = {};

            Object.entries(sources).forEach(([sourceKey, source]) => {
                if (source.floors) {
                    // Zdroj s podlažími - získat vybraná podlaží
                    const floorCheckboxes = document.querySelectorAll(`input[type="checkbox"][data-level="floor"][data-scope="${sourceKey}"]:checked`);
                    const selectedFloors = Array.from(floorCheckboxes).map(cb => cb.value);
                    if (selectedFloors.length > 0) {
                        state.floors[sourceKey] = selectedFloors;
                    }
                } else {
                    // Jednoduchý zdroj - checkbox
                    const sourceCb = document.querySelector(`.source-cb[value="${sourceKey}"]`);
                    if (sourceCb && sourceCb.checked) {
                        state.sources.push(sourceKey);
                    }
                }
            });

            // Časové kontroly
            state.grain = document.getElementById('grain')?.value || '';
            state.period = document.getElementById('period')?.value || '';
            state.view = document.getElementById('view-mode')?.value || '';
            state.lang = document.getElementById('language')?.value || 'cz';

            return state;
        }

        // Aktualizuje URL podle aktuálního stavu filtrů
        function updateURL() {
            const state = getFilterState();
            const params = new URLSearchParams();

            if (state.metrics.length) params.set('metrics', state.metrics.join(','));
            if (state.sections.length) params.set('sections', state.sections.join(','));
            if (state.sources.length) params.set('sources', state.sources.join(','));
            if (state.grain) params.set('grain', state.grain);
            if (state.period) params.set('period', state.period);
            if (state.view) params.set('view', state.view);
            if (state.lang) params.set('lang', state.lang);

            // Podlaží pro každý zdroj zvlášť
            Object.entries(state.floors).forEach(([sourceKey, floors]) => {
                if (floors.length) params.set(`floors_${sourceKey}`, floors.join(','));
            });

            // Aktualizuj URL bez reloadu stránky
            const newURL = params.toString() ? `${window.location.pathname}?${params.toString()}` : window.location.pathname;
            window.history.replaceState(null, '', newURL);
        }

        // Zkopíruje aktuální URL do schránky
        function copyShareURL() {
            const url = window.location.href;

            // Moderní prohlížeče s Clipboard API
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(url).then(() => {
                    showCopyConfirmation();
                }).catch(err => {
                    console.error('Clipboard API failed, trying fallback:', err);
                    fallbackCopy(url);
                });
            } else {
                // Fallback pro starší prohlížeče
                fallbackCopy(url);
            }
        }

        // Fallback metoda pro kopírování
        function fallbackCopy(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-9999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopyConfirmation();
                } else {
                    console.error('Fallback: Nepodařilo se zkopírovat');
                }
            } catch (err) {
                console.error('Fallback: Chyba při kopírování:', err);
            }

            document.body.removeChild(textArea);
        }

        // Zobrazí potvrzení o zkopírování
        function showCopyConfirmation() {
            const btn = document.getElementById('btn-copy-url');
            if (btn) {
                const originalText = btn.textContent;
                btn.textContent = ConfigHelpers.t('copiedToClipboard');
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            }
        }

        // Vyčistí všechny filtry na výchozí hodnoty
        function clearFilters() {
            // Reset metriky - jen globální (venkovní)
            const globalMetrics = Object.entries(DATASET_CONFIG.metrics)
                .filter(([, cfg]) => cfg.global)
                .map(([key]) => key);

            document.querySelectorAll('.metric-cb').forEach(cb => {
                cb.checked = globalMetrics.includes(cb.value);
            });

            // Reset sekce - žádná nevybraná
            document.querySelectorAll('input[type="checkbox"][data-level="section"]').forEach(cb => {
                cb.checked = false;
            });

            // Reset zdrojů
            const sources = DATASET_CONFIG.sources || {};
            Object.entries(sources).forEach(([sourceKey, source]) => {
                if (source.floors) {
                    // ThermoPro - žádná podlaží nevybraná
                    document.querySelectorAll(`input[type="checkbox"][data-level="floor"][data-scope="${sourceKey}"]`).forEach(cb => {
                        cb.checked = false;
                    });
                } else {
                    // Atrea - výchozí hodnota z configu
                    const sourceCb = document.querySelector(`.source-cb[value="${sourceKey}"]`);
                    if (sourceCb) {
                        sourceCb.checked = source.default || false;
                    }
                }
            });

            // Reset časových kontrol na výchozí
            const grainSelect = document.getElementById('grain');
            if (grainSelect) {
                const defaultGrain = DATASET_CONFIG.granularity.find(g => g.default);
                if (defaultGrain) {
                    grainSelect.value = defaultGrain.value || defaultGrain;
                } else {
                    grainSelect.value = DATASET_CONFIG.granularity[0].value;
                }
            }

            const viewSelect = document.getElementById('view-mode');
            if (viewSelect) {
                const defaultView = DATASET_CONFIG.viewModes.find(v => v.default);
                if (defaultView) {
                    viewSelect.value = defaultView.value || defaultView;
                } else {
                    viewSelect.value = DATASET_CONFIG.viewModes[0].value;
                }
            }

            // Reset dropdownu oblíbených
            const favSelect = document.getElementById(DATASET_CONFIG.ui.favoritesDropdown?.id);
            if (favSelect) favSelect.value = '';

            // Aktualizuj periody a překresli
            updatePeriodOptions();
            updateChart();
            updateURL();
        }

        // ===== FAVORITES (localStorage) =====

        const FAVORITES_KEY = 'datex_favorites';

        // Získá oblíbené z localStorage
        function getFavorites() {
            try {
                const stored = localStorage.getItem(FAVORITES_KEY);
                return stored ? JSON.parse(stored) : [];
            } catch (e) {
                console.error('Chyba při načítání oblíbených:', e);
                return [];
            }
        }

        // Uloží oblíbené do localStorage
        function saveFavorites(favorites) {
            try {
                localStorage.setItem(FAVORITES_KEY, JSON.stringify(favorites));
            } catch (e) {
                console.error('Chyba při ukládání oblíbených:', e);
            }
        }

        // Uloží aktuální filtr jako oblíbený
        function saveFavorite() {
            const name = prompt(ConfigHelpers.t('favoriteNamePrompt'));
            if (!name || !name.trim()) return;

            const url = window.location.href;
            const favorites = getFavorites();

            // Přidat nový
            favorites.push({
                id: Date.now().toString(),
                name: name.trim(),
                url: url,
                timestamp: new Date().toISOString()
            });

            saveFavorites(favorites);
            updateFavoritesDropdown();

            // Zobrazit potvrzení
            const btn = document.getElementById('btn-save-favorite');
            if (btn) {
                const originalText = btn.textContent;
                btn.textContent = ConfigHelpers.t('favoriteSaved');
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            }
        }

        // Načte oblíbený filtr
        function loadFavorite(id) {
            if (!id) return;

            const favorites = getFavorites();
            const favorite = favorites.find(f => f.id === id);

            if (favorite) {
                window.location.href = favorite.url;
            }
        }

        // Smaže oblíbený filtr
        function deleteFavorite(id, event) {
            event.stopPropagation();

            if (!confirm(ConfigHelpers.t('deleteFavoriteConfirm'))) return;

            let favorites = getFavorites();
            favorites = favorites.filter(f => f.id !== id);
            saveFavorites(favorites);
            updateFavoritesDropdown();
        }

        // Smaže vybraný oblíbený filtr z dropdownu
        function deleteSelectedFavorite() {
            const config = DATASET_CONFIG.ui.favoritesDropdown;
            if (!config) return;

            const select = document.getElementById(config.id);
            if (!select || !select.value) return;

            const favorites = getFavorites();
            const favorite = favorites.find(f => f.id === select.value);

            if (!favorite) return;

            const confirmMsg = ConfigHelpers.t('deleteFavoriteNamedConfirm').replace('{name}', favorite.name);
            if (confirm(confirmMsg)) {
                const updated = favorites.filter(f => f.id !== select.value);
                saveFavorites(updated);
                updateFavoritesDropdown();
            }
        }

        // Aktualizuje stav tlačítka smazat (povoleno/zakázáno)
        function updateDeleteFavButton() {
            const config = DATASET_CONFIG.ui.favoritesDropdown;
            if (!config || !config.showDelete) return;

            const select = document.getElementById(config.id);
            const deleteBtn = document.getElementById('btn-delete-fav');
            if (!select || !deleteBtn) return;

            deleteBtn.disabled = !select.value;
        }

        // Aktualizuje dropdown oblíbených
        function updateFavoritesDropdown() {
            const config = DATASET_CONFIG.ui.favoritesDropdown;
            if (!config) return;

            const select = document.getElementById(config.id);
            if (!select) return;

            const favorites = getFavorites();

            // Zjisti zda aktuální URL odpovídá některému oblíbenému
            const currentURL = window.location.href;
            const matchingFavorite = favorites.find(fav => {
                try {
                    const favURL = new URL(fav.url);
                    const currURL = new URL(currentURL);
                    return favURL.search === currURL.search;
                } catch {
                    return fav.url === currentURL;
                }
            });

            const currentValue = matchingFavorite ? matchingFavorite.id : select.value;

            select.innerHTML = '';

            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = ConfigHelpers.t('selectFavoritePlaceholder');
            select.appendChild(emptyOption);

            favorites.forEach(fav => {
                const option = document.createElement('option');
                option.value = fav.id;
                option.textContent = fav.name;
                select.appendChild(option);
            });

            select.value = currentValue;
            updateDeleteFavButton();
        }

        // Načte stav filtrů z URL a aplikuje je na UI
        function loadFiltersFromURL() {
            const params = new URLSearchParams(window.location.search);

            // Metriky
            const metricsParam = params.get('metrics');
            if (metricsParam) {
                const metricsToSelect = metricsParam.split(',');
                document.querySelectorAll('.metric-cb').forEach(cb => {
                    cb.checked = metricsToSelect.includes(cb.value);
                });
            }

            // Sekce
            const sectionsParam = params.get('sections');
            if (sectionsParam) {
                const sectionsToSelect = sectionsParam.split(',');
                document.querySelectorAll('input[type="checkbox"][data-level="section"]').forEach(cb => {
                    cb.checked = sectionsToSelect.includes(cb.value);
                });
            }

            // Zdroje
            const sourcesParam = params.get('sources');
            if (sourcesParam) {
                const sourcesToSelect = sourcesParam.split(',');
                document.querySelectorAll('.source-cb').forEach(cb => {
                    cb.checked = sourcesToSelect.includes(cb.value);
                });
            }

            // Podlaží pro každý zdroj
            const sources = DATASET_CONFIG.sources || {};
            Object.entries(sources).forEach(([sourceKey, source]) => {
                if (source.floors) {
                    const floorsParam = params.get(`floors_${sourceKey}`);
                    if (floorsParam) {
                        const floorsToSelect = floorsParam.split(',');
                        document.querySelectorAll(`input[type="checkbox"][data-level="floor"][data-scope="${sourceKey}"]`).forEach(cb => {
                            cb.checked = floorsToSelect.includes(cb.value);
                        });
                    }
                }
            });

            // Časové kontroly
            const grainParam = params.get('grain');
            if (grainParam) {
                const grainSelect = document.getElementById('grain');
                if (grainSelect) grainSelect.value = grainParam;
            }

            const periodParam = params.get('period');
            if (periodParam) {
                const periodSelect = document.getElementById('period');
                if (periodSelect) periodSelect.value = periodParam;
            }

            const viewParam = params.get('view');
            if (viewParam) {
                const viewSelect = document.getElementById('view-mode');
                if (viewSelect) {
                    // Odstraň případné /index.html z konce (pokud je URL špatně naformátovaná)
                    viewSelect.value = viewParam.replace(/\/index\.html$/, '');
                }
            }

            // Jazyk
            const langParam = params.get('lang');
            if (langParam) {
                const langSelect = document.getElementById('language');
                if (langSelect) langSelect.value = langParam;
            }
        }

        // ===== INIT UI Z CONFIGU =====
        function initUIFromConfig() {
            initHeader();
            initTimeControls();
            initFilters();
            // Dynamické location levels se inicializují v initDynamicLocationLevels() po načtení dat
        }

        function initHeader() {
            const titleEl = document.getElementById('header-title');
            const subtitleEl = document.getElementById('header-subtitle');

            if (titleEl) titleEl.textContent = DATASET_CONFIG.ui.header.title;
            if (subtitleEl) subtitleEl.textContent = DATASET_CONFIG.ui.header.subtitle;

            // Vytvoř tlačítka v headeru
            initHeaderActions();
        }

        function initHeaderActions() {
            const actionsContainer = document.getElementById('header-actions');
            if (!actionsContainer) return;

            DATASET_CONFIG.ui.actionButtons.forEach(btn => {
                const button = document.createElement('button');
                button.className = `nav-btn ${btn.class}`;
                button.textContent = btn.label;
                button.id = btn.id;

                // Nastav onclick podle action názvu
                if (btn.action === 'copyShareURL') {
                    button.onclick = () => copyShareURL();
                } else if (btn.action === 'saveFavorite') {
                    button.onclick = () => saveFavorite();
                } else if (btn.action === 'clearFilters') {
                    button.onclick = () => clearFilters();
                }

                actionsContainer.appendChild(button);
            });
        }

        function initTimeControls() {
            const panel = document.getElementById('time-controls-panel');
            if (!panel) {
                console.error('time-controls-panel not found');
                return;
            }

            // Vytvoř control group pro každé time control
            DATASET_CONFIG.ui.timeControls.forEach(control => {
                const group = document.createElement('div');
                group.className = 'control-group';

                const label = document.createElement('label');
                label.textContent = control.label;
                group.appendChild(label);

                const select = document.createElement('select');
                select.id = control.id;

                if (!control.dynamic) {
                    // Naplní se z configu (viewModes, granularity) nebo z inline options
                    let options = [];
                    if (control.options) {
                        // Inline options (např. pro language select)
                        options = control.options;
                    } else if (control.configKey) {
                        // Options z configu
                        options = DATASET_CONFIG[control.configKey] || [];
                    }

                    options.forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt.value || opt;
                        option.textContent = opt.label || opt;
                        if (opt.default) option.selected = true;
                        select.appendChild(option);
                    });
                }
                // dynamic select (period) se naplní později z dat

                group.appendChild(select);
                panel.appendChild(group);
            });

            // Přidat dropdown pro oblíbené
            const favConfig = DATASET_CONFIG.ui.favoritesDropdown;
            if (favConfig) {
                const favGroup = document.createElement('div');
                favGroup.className = 'control-group';

                const favLabel = document.createElement('label');
                favLabel.textContent = favConfig.label;
                favGroup.appendChild(favLabel);

                // Wrapper pro select a tlačítko smazat
                const favWrapper = document.createElement('div');
                favWrapper.className = 'favorites-wrapper';

                const favSelect = document.createElement('select');
                favSelect.id = favConfig.id;
                favSelect.className = 'favorites-select';

                // Prázdná option
                const emptyOption = document.createElement('option');
                emptyOption.value = '';
                emptyOption.textContent = favConfig.emptyLabel || '-- Vyber --';
                favSelect.appendChild(emptyOption);

                // Event listener pro načtení oblíbeného
                favSelect.addEventListener('change', () => {
                    updateDeleteFavButton();
                    if (favSelect.value) {
                        loadFavorite(favSelect.value);
                    }
                });

                favWrapper.appendChild(favSelect);

                // Tlačítko pro smazání vybraného oblíbeného
                if (favConfig.showDelete) {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.id = 'btn-delete-fav';
                    deleteBtn.className = 'btn-delete-fav';
                    deleteBtn.textContent = ConfigHelpers.t('favoriteDeleteIcon');
                    deleteBtn.title = ConfigHelpers.t('favoriteDeleteTitle');
                    deleteBtn.disabled = true;
                    deleteBtn.onclick = () => deleteSelectedFavorite();
                    favWrapper.appendChild(deleteBtn);
                }

                favGroup.appendChild(favWrapper);
                panel.appendChild(favGroup);
            }

            // Přidat navigační tlačítka (Zpět/Vpřed) zarovnaná doprava
            const navButtons = document.createElement('div');
            navButtons.className = 'nav-buttons push-right';

            DATASET_CONFIG.ui.navButtons.forEach(btn => {
                const button = document.createElement('button');
                button.className = `nav-btn ${btn.class}`;
                button.textContent = btn.label;
                button.id = btn.id;

                // Nastav onclick podle action názvu
                if (btn.action === 'priorPeriod') {
                    button.onclick = () => priorPeriod();
                } else if (btn.action === 'nextPeriod') {
                    button.onclick = () => nextPeriod();
                }

                navButtons.appendChild(button);
            });

            panel.appendChild(navButtons);
        }

        function initFilters() {
            const panel = document.getElementById('data-filters-panel');
            if (!panel) {
                console.error('data-filters-panel not found');
                return;
            }

            // 1. Globální location levely
            const globalLevels = DATASET_CONFIG.locationHierarchy?.global || [];
            globalLevels.forEach(level => {
                createLocationFilter(panel, level, 'global');
            });

            // 2. Metriky (z filters configu)
            const metricsFilter = ConfigHelpers.getFilter('metrics');
            if (metricsFilter) {
                createMetricsFilter(panel, metricsFilter);
            }

            // 3. Zdroje s jejich specifickými levely
            const sourcesFilter = ConfigHelpers.getFilter('sources');
            if (sourcesFilter) {
                createSourcesFilter(panel, sourcesFilter);
            }
        }

        function createLocationFilter(panel, levelConfig, scope) {
            const group = document.createElement('div');
            group.className = 'control-group';
            group.dataset.filterKey = levelConfig.key;
            group.dataset.filterScope = scope;

            const label = document.createElement('label');
            label.textContent = levelConfig.label;
            group.appendChild(label);

            const content = document.createElement('div');
            content.style.display = 'flex';
            content.style.gap = '0.75rem';
            content.style.alignItems = 'center';
            content.style.flexWrap = 'wrap';
            content.dataset.filterContent = levelConfig.key;

            group.appendChild(content);
            panel.appendChild(group);

            // Pokud jsou items definované, vygeneruj checkboxy
            if (levelConfig.items !== 'dynamic') {
                const defaultValues = Array.isArray(levelConfig.default) ? levelConfig.default : [];

                if (Array.isArray(levelConfig.items)) {
                    levelConfig.items.forEach(value => {
                        const itemLabel = levelConfig.itemLabel ? levelConfig.itemLabel(value) : String(value);
                        createLocationCheckbox(content, levelConfig.key, value, itemLabel, defaultValues.includes(value), scope);
                    });
                }
            }
            // Dynamic items (např. podlaží) se naplní později v initHierarchicalSubItems()
        }

        function createMetricsFilter(panel, filterConfig) {
            const group = document.createElement('div');
            group.className = 'control-group';
            group.dataset.filterKey = filterConfig.key;

            const label = document.createElement('label');
            label.textContent = filterConfig.label;
            group.appendChild(label);

            const content = document.createElement('div');
            content.style.display = 'flex';
            content.style.gap = '0.75rem';
            content.style.alignItems = 'center';
            content.style.flexWrap = 'wrap';

            group.appendChild(content);
            panel.appendChild(group);

            // Získej metriky z configu
            const items = DATASET_CONFIG[filterConfig.configKey] || {};
            const defaultValues = typeof filterConfig.default === 'function'
                ? filterConfig.default(items)
                : [];

            Object.entries(items).forEach(([key, config]) => {
                const itemLabel = filterConfig.itemLabel ? filterConfig.itemLabel(key, config) : key;
                createCheckbox(content, filterConfig.checkboxClass, key, itemLabel, defaultValues.includes(key));
            });
        }

        function createLocationCheckbox(container, levelKey, value, label, checked, scope) {
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'location-cb';
            checkbox.dataset.level = levelKey;
            checkbox.dataset.scope = scope;
            checkbox.value = value;
            checkbox.checked = checked;

            checkbox.addEventListener('change', (e) => {
                updateLocationState(levelKey, value, e.target.checked, scope);
                updatePeriodOptions(e.target.checked);
                updateChart();
                updateURL();
            });

            const labelEl = document.createElement('label');
            labelEl.style.display = 'flex';
            labelEl.style.alignItems = 'center';
            labelEl.style.gap = '0.25rem';
            labelEl.style.cursor = 'pointer';
            labelEl.appendChild(checkbox);
            labelEl.appendChild(document.createTextNode(` ${label}`));

            container.appendChild(labelEl);
        }

        function renderCheckboxesFilter(filter, container) {
            const items = filter.items;
            const isArray = Array.isArray(items);

            // Získat výchozí hodnoty
            let defaultValues;
            if (typeof filter.default === 'function') {
                defaultValues = filter.default(items);
            } else if (filter.default === 'all') {
                defaultValues = isArray ? items : Object.keys(items);
            } else if (Array.isArray(filter.default)) {
                defaultValues = filter.default;
            } else {
                defaultValues = [];
            }

            // Vytvořit checkboxy
            if (isArray) {
                items.forEach(value => {
                    const itemLabel = filter.itemLabel ? filter.itemLabel(value) : String(value);
                    createCheckbox(container, filter.checkboxClass, value, itemLabel, defaultValues.includes(value));
                });
            } else {
                Object.entries(items).forEach(([key, config]) => {
                    const itemLabel = filter.itemLabel ? filter.itemLabel(key, config) : key;
                    createCheckbox(container, filter.checkboxClass, key, itemLabel, defaultValues.includes(key));
                });
            }
        }

        function createCheckbox(container, className, value, label, checked, onChange) {
            const labelEl = document.createElement('label');
            labelEl.style.display = 'flex';
            labelEl.style.alignItems = 'center';
            labelEl.style.gap = '0.25rem';
            labelEl.style.cursor = 'pointer';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = className;
            checkbox.value = value;
            checkbox.checked = checked;

            checkbox.addEventListener('change', (e) => {
                // Custom onChange handler pokud je poskytnut
                if (onChange) {
                    onChange(e.target.checked, value);
                }
                updatePeriodOptions(e.target.checked);
                updateChart();
                updateURL();
            });

            labelEl.appendChild(checkbox);
            labelEl.appendChild(document.createTextNode(` ${label}`));
            container.appendChild(labelEl);
        }

        function createSourcesFilter(panel, filterConfig) {
            const sources = DATASET_CONFIG.sources || {};

            Object.values(sources).forEach(source => {
                // 1. Vytvoř checkbox pro samotný zdroj
                const sourceGroup = document.createElement('div');
                sourceGroup.className = 'control-group';
                sourceGroup.dataset.filterKey = 'sources';
                sourceGroup.dataset.sourceKey = source.key;

                const sourceLabel = document.createElement('label');
                sourceLabel.textContent = source.label;
                sourceGroup.appendChild(sourceLabel);

                const sourceContent = document.createElement('div');
                sourceContent.style.display = 'flex';
                sourceContent.style.gap = '0.75rem';
                sourceContent.style.alignItems = 'center';
                sourceContent.style.flexWrap = 'wrap';

                // Checkbox pro zdroj (jen pro zdroje BEZ floors - pro zdroje s floors se vybírají přímo podlaží)
                if (!source.floors) {
                    const defaultChecked = source.default ?? false;
                    createCheckbox(
                        sourceContent,
                        filterConfig.checkboxClass,
                        source.key,
                        source.checkboxLabel || source.label,
                        defaultChecked,
                        (checked, value) => {
                            setSourceState(value, checked);
                        }
                    );
                }

                sourceGroup.appendChild(sourceContent);
                panel.appendChild(sourceGroup);

                // 2. Přidej specifické location levels pro tento zdroj
                const sourceLevels = DATASET_CONFIG.locationHierarchy?.sources?.[source.key] || [];
                sourceLevels.forEach(level => {
                    createLocationFilter(panel, level, source.key);
                });
            });
        }

        // Naplní dynamické location levely po načtení dat
        function initDynamicLocationLevels() {
            if (!rawData) return;

            const sources = DATASET_CONFIG.sources || {};

            Object.entries(sources).forEach(([sourceKey, source]) => {
                const sourceLevels = DATASET_CONFIG.locationHierarchy?.sources?.[sourceKey] || [];

                sourceLevels.forEach(level => {
                    // Najdi kontejner pro tento level
                    const levelContainer = document.querySelector(`[data-filter-key="${level.key}"][data-filter-scope="${sourceKey}"] [data-filter-content]`);
                    if (!levelContainer) {
                        console.log(`⚠️ Kontejner nenalezen pro ${sourceKey}.${level.key}, selector: [data-filter-key="${level.key}"][data-filter-scope="${sourceKey}"] [data-filter-content]`);
                        return;
                    }

                    // Pokud je items: 'dynamic', zjisti hodnoty z dat
                    if (level.items === 'dynamic') {
                        const values = new Set();

                        rawData.forEach(row => {
                            const location = ConfigHelpers.getColumn(row, 'location');
                            const floor = ConfigHelpers.getColumn(row, 'floor');

                            // Pouze řádky pro tento zdroj
                            if (floor !== source.floorValue) return;

                            // Parsovat hodnotu levelu z location
                            const parsedValue = ConfigHelpers.parseLocationLevel(location, level, source);
                            if (parsedValue) {
                                // Aplikuj filtr pokud existuje
                                if (level.itemFilter && !level.itemFilter(parsedValue)) return;
                                values.add(parsedValue);
                            }
                        });

                        console.log(`Dynamic values for ${sourceKey}.${level.key}:`, Array.from(values));

                        // Seřad - použij customSort z configu nebo výchozí abecední řazení
                        const valuesArray = Array.from(values);
                        const sortedValues = level.customSort
                            ? valuesArray.sort(level.customSort)
                            : valuesArray.sort();

                        sortedValues.forEach(value => {
                            const itemLabel = level.itemLabel ? level.itemLabel(value) : String(value);
                            createLocationCheckbox(levelContainer, level.key, value, itemLabel, false, sourceKey);
                        });
                    }
                });
            });
        }

        // ===== SPRÁVA PERIOD =====

        // Získá všechny dostupné periody z dat pro danou granularitu, vybrané metriky, location levely a zdroje
        function getAvailablePeriods(grain) {
            if (!rawData) return [];

            // Získej vybrané metriky
            const metricCheckboxes = document.querySelectorAll('.metric-cb:checked');
            const selectedMetrics = Array.from(metricCheckboxes).map(cb => cb.value);

            // Zjisti, zda jsou vybrány nějaké location filtry (sekce, podlaží, atd.)
            const hasLocationFilters = hasAnyLocationFilterSelected();

            // Získej vybrané sekce PŘÍMO z DOM checkboxů
            const sectionCheckboxes = document.querySelectorAll('input[type="checkbox"][data-level="section"]:checked');
            const selectedSections = new Set(Array.from(sectionCheckboxes).map(cb => String(cb.value)));

            const periods = new Set();
            let processedRows = 0;
            let filteredRows = 0;

            rawData.forEach(row => {
                const rowMetric = ConfigHelpers.getColumn(row, 'metric');
                const location = ConfigHelpers.getColumn(row, 'location');
                const floor = ConfigHelpers.getColumn(row, 'floor');

                // Použij jen řádky pro vybrané metriky
                if (!selectedMetrics.includes(rowMetric)) return;
                processedRows++;

                // Pro ne-ambient metriky filtruj i podle sekce, podlaží a zdrojů
                // POUZE pokud jsou vybrány nějaké location filtry
                const isAmbient = ConfigHelpers.isGlobalMetric(rowMetric);
                if (!isAmbient && hasLocationFilters) {
                    // Sekce je vždy poslední znak location (funguje pro sm2_01, 1NP-1, atd.)
                    const rowSection = parseInt(location.slice(-1));

                    // Pokud není sekce vybraná, řádek se nepočítá (stejně jako v původní verzi)
                    if (!selectedSections.has(String(rowSection))) return;

                    // Filtruj podle zdroje a podlaží
                    const source = ConfigHelpers.getSourceByFloor(floor);
                    if (!source) return;

                    if (source.floors) {
                        // ThermoPro - MUSÍ být vybráno alespoň jedno podlaží
                        const floorCode = ConfigHelpers.getFloorCode(location, source);
                        const selectedItems = getSourceItems(source.key);
                        if (!floorCode || !selectedItems || selectedItems.size === 0 || !selectedItems.has(floorCode)) return;
                    } else {
                        // Simple zdroj (Atrea) - musí být vybrán
                        if (!isSourceSelected(source.key)) return;
                    }
                }

                filteredRows++;

                const time = ConfigHelpers.getColumn(row, 'time');
                const year = time.getFullYear();
                const month = String(time.getMonth() + 1).padStart(2, '0');
                const day = String(time.getDate()).padStart(2, '0');

                if (grain === 'month') {
                    periods.add(String(year));
                } else if (grain === 'day') {
                    periods.add(`${year}-${month}`);
                } else if (grain === 'hour') {
                    periods.add(`${year}-${month}-${day}`);
                }
            });

            console.log(`getAvailablePeriods: processed=${processedRows}, filtered=${filteredRows}, periods=${periods.size}, metrics=${selectedMetrics.join(',')}, hasLocationFilters=${hasLocationFilters}`);
            if (periods.size === 0 && processedRows > 0) {
                console.log('⚠️ Žádné periody nalezeny, ale řádky existují!');
            }

            return Array.from(periods).sort();
        }

        // Pomocná funkce: zjistí, zda jsou vybrány nějaké location filtry
        function hasAnyLocationFilterSelected() {
            // Globální location filtry (sekce) - čti PŘÍMO z DOM
            const globalLevels = DATASET_CONFIG.locationHierarchy?.global || [];
            for (const level of globalLevels) {
                const checkboxes = document.querySelectorAll(`input[type="checkbox"][data-level="${level.key}"]:checked`);
                if (checkboxes.length > 0) return true;
            }

            // Source-specific filtry (podlaží)
            const sources = DATASET_CONFIG.sources || {};
            for (const [sourceKey, source] of Object.entries(sources)) {
                if (source.floors) {
                    const selectedItems = getSourceItems(sourceKey);
                    if (selectedItems && selectedItems.size > 0) return true;
                } else {
                    const selected = isSourceSelected(sourceKey);
                    if (selected) return true;
                }
            }

            return false;
        }

        // Získá poslední úplnou periodu v datech
        function getLastCompletePeriod(grain) {
            const periods = getAvailablePeriods(grain);
            if (periods.length === 0) return null;

            // Poslední perioda je již seřazena
            return periods[periods.length - 1];
        }

        // Aktualizuje options v selectu Perioda podle granularity
        // isAdding: true = filtr byl přidán (checkbox zaškrtnut), false/undefined = filtr odebrán nebo jiná změna
        // skipChart: true = nevolat updateChart() na konci
        // urlPeriod: perioda z URL parametru (použije se když previousPeriod je prázdné)
        function updatePeriodOptions(isAdding, skipChart = false, urlPeriod = null) {
            const grain = document.getElementById('grain').value;
            const periodSelect = document.getElementById('period');

            // Ulož si aktuálně vybranou periodu (před změnou options)
            const previousPeriod = periodSelect.value;

            // Získaj dostupné periody - použit aktuální filtr
            const periods = getAvailablePeriods(grain);

            // Vymaž existující options
            periodSelect.innerHTML = '';

            if (periods.length === 0) {
                // Žádné periody
                const option = document.createElement('option');
                option.value = '';
                option.textContent = ConfigHelpers.t('noData');
                periodSelect.appendChild(option);
                return;
            }

            // Přidej nové options (seřazeno vzestupně)
            periods.forEach(period => {
                const option = document.createElement('option');
                option.value = period;
                option.textContent = period;
                periodSelect.appendChild(option);
            });

            // Rozhodni o periodě:
            // - Při PŘIDÁNÍ filtru (isAdding = true) → vždy ponechat aktuální periodu
            // - Při ODEBRÁNÍ filtru (isAdding = false) → hledat nejbližší minulou periodu s daty
            // - Při změně granularity nebo první načtení → respektovat previousPeriod z URL
            let selectedPeriod;

            if (isAdding === true && previousPeriod && periods.includes(previousPeriod)) {
                // Přidávání filtru → ponechat aktuální periodu
                selectedPeriod = previousPeriod;
            } else if (isAdding === false && previousPeriod && periods.includes(previousPeriod)) {
                // Odebírání filtru → zjistit, zda má aktuální perioda data pro nový filtr
                periodSelect.value = previousPeriod;
                const hasData = quickFilterDataCheck();

                if (hasData) {
                    // Aktuální perioda má data → zůstaň v ní
                    selectedPeriod = previousPeriod;
                } else {
                    // Aktuální perioda nemá data → najdi nejbližší minulou s daty
                    const prevIndex = periods.indexOf(previousPeriod);
                    let found = false;
                    if (prevIndex > 0) {
                        for (let i = prevIndex - 1; i >= 0; i--) {
                            periodSelect.value = periods[i];
                            if (quickFilterDataCheck()) {
                                selectedPeriod = periods[i];
                                found = true;
                                break;
                            }
                        }
                    }
                    if (!found) {
                        // Žádná minulá perioda s daty → ponechat aktuální + info
                        selectedPeriod = previousPeriod;
                        updateHeader('ℹ️ ' + ConfigHelpers.t('noDataInHistory'));
                    }
                }
            } else {
                // Změna granularity nebo první načtení
                // Priorita: urlPeriod > previousPeriod > poslední perioda
                const periodFromURL = urlPeriod || previousPeriod;

                if (periodFromURL && periods.includes(periodFromURL)) {
                    selectedPeriod = periodFromURL;
                } else {
                    selectedPeriod = periods[periods.length - 1];
                }
            }

            periodSelect.value = selectedPeriod;

            // Aktualizuj graf po změně filtrů (pokud není skipChart)
            if (!skipChart) {
                updateChart();
            }
        }

        // Filtruje řádek podle vybrané periody
        function filterByPeriod(row, grain, period) {
            const time = ConfigHelpers.getColumn(row, 'time');
            const year = time.getFullYear();
            const month = String(time.getMonth() + 1).padStart(2, '0');
            const day = String(time.getDate()).padStart(2, '0');

            if (grain === 'month') {
                return String(year) === period;
            } else if (grain === 'day') {
                return `${year}-${month}` === period;
            } else if (grain === 'hour') {
                return `${year}-${month}-${day}` === period;
            }
            return false;
        }

        // Navigace na předchozí periodu
        function priorPeriod() {
            const grain = document.getElementById('grain').value;
            const periodSelect = document.getElementById('period');
            const periods = getAvailablePeriods(grain);
            const currentIndex = periods.indexOf(periodSelect.value);

            if (currentIndex > 0) {
                const newPeriod = periods[currentIndex - 1];
                // Ověř, že nová perioda bude mít data (dělá se to v filterData)
                // Temporarily set new period to check
                const oldPeriod = periodSelect.value;
                periodSelect.value = newPeriod;

                // Quick check - filter data with new period
                const testFilter = quickFilterDataCheck();
                periodSelect.value = oldPeriod;

                if (testFilter) {
                    periodSelect.value = newPeriod;
                    updateChart();
                    updateURL();
                } else {
                    updateHeader('ℹ️ ' + ConfigHelpers.t('oldestPeriodReached'));
                }
            } else {
                // Jsme na nejstarší periodě
                updateHeader(`ℹ️ Aktuálně vybraná perioda je nejstarší dostupná pro daný výběr dat.`);
            }
        }

        // Navigace na další periodu
        function nextPeriod() {
            const grain = document.getElementById('grain').value;
            const periodSelect = document.getElementById('period');
            const periods = getAvailablePeriods(grain);
            const currentIndex = periods.indexOf(periodSelect.value);

            if (currentIndex < periods.length - 1) {
                const newPeriod = periods[currentIndex + 1];
                // Ověř, že nová perioda bude mít data
                const oldPeriod = periodSelect.value;
                periodSelect.value = newPeriod;

                const testFilter = quickFilterDataCheck();
                periodSelect.value = oldPeriod;

                if (testFilter) {
                    periodSelect.value = newPeriod;
                    updateChart();
                    updateURL();
                } else {
                    updateHeader('ℹ️ ' + ConfigHelpers.t('newestPeriodReached'));
                }
            } else {
                // Jsme na nejnovější periodě
                updateHeader(`ℹ️ Aktuálně vybraná perioda je nejnovější dostupná pro daný výběr dat.`);
            }
        }

        // Rychlá kontrola zda existují data pro aktuálně vybranou periodu
        function quickFilterDataCheck() {
            if (!rawData) return false;

            // Získej vybrané sekce PŘÍMO z DOM checkboxů
            const sectionCheckboxes = document.querySelectorAll('input[type="checkbox"][data-level="section"]:checked');
            const selectedSections = new Set(Array.from(sectionCheckboxes).map(cb => String(cb.value)));

            const metricCheckboxes = document.querySelectorAll('.metric-cb:checked');
            const selectedMetrics = Array.from(metricCheckboxes).map(cb => cb.value);

            const grain = document.getElementById('grain').value;
            const period = document.getElementById('period').value;

            // Zkus najít alespoň jeden řádek
            for (let i = 0; i < rawData.length; i++) {
                const row = rawData[i];
                const location = ConfigHelpers.getColumn(row, 'location');
                const rowMetric = ConfigHelpers.getColumn(row, 'metric');
                const floor = ConfigHelpers.getColumn(row, 'floor');
                const source = ConfigHelpers.getSourceByFloor(floor);

                // Filtry
                const isAmbient = ConfigHelpers.isGlobalMetric(rowMetric);
                if (!selectedMetrics.includes(rowMetric)) continue;

                if (!isAmbient) {
                    if (!source) continue;

                    // Sekce je vždy poslední znak location
                    const rowSection = parseInt(location.slice(-1));
                    // Pokud není sekce vybraná, řádek se nepočítá
                    if (!selectedSections.has(String(rowSection))) continue;

                    // Filtruj podle zdroje a podlaží
                    if (source.floors) {
                        const floorCode = ConfigHelpers.getFloorCode(location, source);
                        const selectedItems = getSourceItems(source.key);
                        // ThermoPro - MUSÍ být vybráno alespoň jedno podlaží
                        if (!floorCode || !selectedItems || selectedItems.size === 0 || !selectedItems.has(floorCode)) continue;
                    } else {
                        if (!isSourceSelected(source.key)) continue;
                    }
                }

                if (!filterByPeriod(row, grain, period)) continue;

                // Našli jsme alespoň jeden řádek
                return true;
            }

            return false;
        }

        // Načti Parquet pomocí hyparquet
        async function loadParquet(url) {
            const resp = await fetch(url);
            const arrayBuffer = await resp.arrayBuffer();

            return new Promise((resolve, reject) => {
                parquetRead({
                    file: arrayBuffer,
                    onComplete: (data) => resolve(data),
                    onError: (err) => reject(err)
                });
            });
        }

        async function loadData() {
            try {
                const data = await loadParquet(DATASET_CONFIG.source.url);

                console.log('Počet řádků:', data.length);
                if (data.length > 0) {
                    console.log('Ukázka prvního řádku:', data[0]);
                    console.log('Délka řádku (počet sloupců):', data[0].length);
                }

                rawData = data;

                // Zobraz info o načtení v záhlaví
                updateHeader(ConfigHelpers.t('dataLoaded', {count: data.length.toLocaleString()}));

                initDynamicLocationLevels();
                updateFavoritesDropdown();  // Načti oblíbené do dropdownu
                loadFiltersFromURL();
                // Inicializuj options pro Perioda podle granularity PO načtení filtrů z URL
                // Přečti period parametr z URL pro správné nastavení
                const urlParams = new URLSearchParams(window.location.search);
                const urlPeriod = urlParams.get('period');
                updatePeriodOptions(undefined, true, urlPeriod);
                updateChart();
            } catch (error) {
                showError(ConfigHelpers.t('errorLoading', {error: error.message}));
                console.error(error);
            }
        }

        // Filtruj data podle parametrů
        function filterData() {
            if (!rawData) return [];

            // Získej vybrané metriky
            const metricCheckboxes = document.querySelectorAll('.metric-cb:checked');
            const selectedMetrics = Array.from(metricCheckboxes).map(cb => cb.value);

            // Získej vybrané sekce PŘÍMO z DOM checkboxů
            const sectionCheckboxes = document.querySelectorAll('input[type="checkbox"][data-level="section"]:checked');
            const selectedSections = new Set(Array.from(sectionCheckboxes).map(cb => String(cb.value)));

            const grain = document.getElementById('grain').value;
            const period = document.getElementById('period').value;

            console.log('Filtruji: sections=' + Array.from(selectedSections).join(',') + ', metrics=' + selectedMetrics.join(',') + ', grain=' + grain + ', period=' + period);

            const data = rawData.filter(row => {
                const location = ConfigHelpers.getColumn(row, 'location');
                const rowMetric = ConfigHelpers.getColumn(row, 'metric');
                const floor = ConfigHelpers.getColumn(row, 'floor');
                const source = ConfigHelpers.getSourceByFloor(floor);

                // Pro ne-ambient metriky filtruj podle sekce, podlaží a zdrojů
                const isAmbient = ConfigHelpers.isGlobalMetric(rowMetric);
                if (!isAmbient) {
                    if (!source) return false;

                    // Sekce je vždy poslední znak location (funguje pro sm2_01, 1NP-1, atd.)
                    const rowSection = parseInt(location.slice(-1));
                    // Pokud není sekce vybraná, řádek se neukáže (stejně jako v původní verzi)
                    if (!selectedSections.has(String(rowSection))) {
                        return false;
                    }

                    // Filtruj podle zdroje a podlaží
                    if (source.floors) {
                        // ThermoPro - MUSÍ být vybráno alespoň jedno podlaží
                        const selectedItems = getSourceItems(source.key);
                        const floorCode = ConfigHelpers.getFloorCode(location, source);
                        if (!floorCode || !selectedItems || selectedItems.size === 0 || !selectedItems.has(floorCode)) {
                            return false;
                        }
                    } else {
                        if (!isSourceSelected(source.key)) return false;
                    }
                }

                // Filtruj podle vybraných metrik
                if (!selectedMetrics.includes(rowMetric)) return false;

                // Filtruj podle vybrané periody
                if (!filterByPeriod(row, grain, period)) return false;

                return true;
            });

            // Statistika metrik ve filtrovaných datech
            const metricCounts = {};
            data.forEach(row => {
                const metric = ConfigHelpers.getColumn(row, 'metric');
                metricCounts[metric] = (metricCounts[metric] || 0) + 1;
            });
            console.log(`Filtrováno ${data.length} řádků z ${rawData.length} celkem`);
            console.log('Počet řádků podle metrik:', metricCounts);

            // Převed filtrovaná data na strukturované objekty
            const filteredData = data.map(row => ({
                time: ConfigHelpers.getColumn(row, 'time'),
                location: ConfigHelpers.getColumn(row, 'location'),
                floor: ConfigHelpers.getColumn(row, 'floor'),
                metric: ConfigHelpers.getColumn(row, 'metric'),
                value: ConfigHelpers.getColumn(row, 'value')
            }));

            // Agregace podle granularity - seskupujeme podle location a metriky
            const grouped = new Map();

            filteredData.forEach(row => {
                let key;
                if (grain === 'month') {
                    key = new Date(row.time.getFullYear(), row.time.getMonth(), 1);
                } else if (grain === 'day') {
                    key = new Date(row.time.getFullYear(), row.time.getMonth(), row.time.getDate());
                } else {
                    key = new Date(row.time.getFullYear(), row.time.getMonth(), row.time.getDate(), row.time.getHours());
                }

                // Pro globální metriky ignoruj location
                const isAmbient = ConfigHelpers.isGlobalMetric(row.metric);
                const groupKey = isAmbient
                    ? `${key.toISOString()}|ambient|${row.metric}`
                    : `${key.toISOString()}|${row.location}|${row.metric}`;

                if (!grouped.has(groupKey)) {
                    grouped.set(groupKey, {
                        time_period: key,
                        location: isAmbient ? 'ambient' : row.location,
                        floor: isAmbient ? 'ambient' : row.floor,  // floor pro zkrácený popisek
                        metric: row.metric,  // metric type
                        values: []
                    });
                }
                grouped.get(groupKey).values.push(row.value);
            });

            // Spočít průměry
            const result = [];
            grouped.forEach((v) => {
                const avg = v.values.reduce((a, b) => a + b, 0) / v.values.length;
                result.push({
                    time_period: v.time_period,
                    location: v.location,
                    floor: v.floor,  // floor pro zkrácený popisek
                    metric: v.metric,  // metric type
                    value: avg,
                    min_value: Math.min(...v.values),
                    max_value: Math.max(...v.values),
                    count: v.values.length
                });
            });

            return result.sort((a, b) => a.time_period - b.time_period);
        }

        // Aktualizuj graf
        async function updateChart() {
            if (!rawData) {
                showError(ConfigHelpers.t('errorLoading', {error: 'Data ještě nejsou načtena'}));
                return;
            }

            const grain = document.getElementById('grain').value;

            // Aktualizuj záhlaví
            updateHeader();

            try {
                currentData = filterData();

                if (currentData.length === 0) {
                    // Znič existující graf
                    if (chart) {
                        chart.destroy();
                        chart = null;
                    }
                    showError(ConfigHelpers.t('errorNoData'));
                    return;
                }

                // Získej jednotlivé kombinace location+metric pro seskupení dat
                let locsWithLabels = [];
                const uniqueLocMetric = [...new Set(currentData.map(d => `${d.location}|${d.metric}`))];

                console.log('Počet unikátních location+metric kombinací:', uniqueLocMetric.length);
                console.log('Kombinace:', uniqueLocMetric);

                uniqueLocMetric.forEach(lm => {
                    const parts = lm.split('|');
                    if (parts.length < 2) return; // bezpečnostní kontrola
                    const [loc, metricType] = parts;

                    const locData = currentData.filter(x => x.location === loc && x.metric === metricType);
                    if (!locData.length) return; // žádná data pro tuto kombinaci

                    const floor = locData[0]?.floor || '';
                    const metricName = ConfigHelpers.getMetricLabel(metricType);

                    // Zjisti zdroj z configu (generické)
                    const source = ConfigHelpers.getSourceByFloor(floor);

                    // Získej číslo sekce z location podle zdroje (generické)
                    let sectionNumber = '';
                    if (source) {
                        sectionNumber = ConfigHelpers.parseSection(loc, source) || '';
                        // Debug: ověř sectionNumber
                        if (sectionNumber === '' && loc !== 'ambient') {
                            console.log('⚠️ Prázdný sectionNumber:', {loc, source: source.key, floor});
                        }
                    }

                    // Zjisti typ pro řazení a filtrování
                    let type;
                    let floorCode = '';
                    let label;

                    // Pro globální metriky nezobrazuj sekci ani podlaží
                    if (ConfigHelpers.isGlobalMetric(metricType)) {
                        type = 'ambient';
                        label = metricName;
                    } else if (source) {
                        // Generická logika podle configu zdroje
                        type = ConfigHelpers.getSortType(loc, source);
                        floorCode = source.floors ? ConfigHelpers.getFloorCode(loc, source) : '';

                        if (source.floors) {
                            label = floorCode ? `${ConfigHelpers.t('section')} ${sectionNumber} ${floorCode} ${metricName}` : `${ConfigHelpers.t('section')} ${sectionNumber} ${metricName}`;
                        } else {
                            label = `${ConfigHelpers.t('section')} ${sectionNumber} ${metricName}`;
                        }
                    } else {
                        // Fallback - když zdroj není v configu
                        type = loc;
                        label = `${ConfigHelpers.t('section')} ${sectionNumber} ${metricName}`;
                    }

                    locsWithLabels.push({
                        loc,
                        metric: metricType,
                        label,
                        type,
                        floor,
                        floorCode,
                        sectionNumber,
                        sortPriority: source?.sortPriority || 999  // Pro řazení podle zdroje
                    });
                    console.log(`Vytvořen label: "${label}" pro loc=${loc}, sectionNumber="${sectionNumber}"`);
                });

                // Řazení: 1) metrika, 2) sekce, 3) zdroj (podlaží)
                // Pořadí metrik z configu
                const metricOrder = ConfigHelpers.getMetricsInOrder().map(m => m.key);

                locsWithLabels.sort((a, b) => {
                    // 1. Řazení podle metriky
                    const metricIndexA = metricOrder.indexOf(a.metric);
                    const metricIndexB = metricOrder.indexOf(b.metric);
                    if (metricIndexA !== metricIndexB) {
                        return metricIndexA - metricIndexB;
                    }

                    // 2. Řazení podle sekce
                    const sectionA = parseInt(a.sectionNumber) || 0;
                    const sectionB = parseInt(b.sectionNumber) || 0;
                    if (sectionA !== sectionB) {
                        return sectionA - sectionB;
                    }

                    // 3. Řazení podle zdroje (podle sortPriority z configu)
                    if (a.sortPriority !== b.sortPriority) {
                        return a.sortPriority - b.sortPriority;
                    }

                    // 4. Řazení podle podlaží (pro stejné zdroje)
                    // NP sestupně, PP vzestupně (generické podle type)

                    if (a.type === 'NP' && b.type === 'PP') return -1;
                    if (b.type === 'NP' && a.type === 'PP') return 1;

                    // Stejný typ - řadit podle čísla podlaží
                    if (a.type === 'NP' && b.type === 'NP') {
                        const numA = parseInt(a.floorCode.replace(/\D/g, '')) || 0;
                        const numB = parseInt(b.floorCode.replace(/\D/g, '')) || 0;
                        return numB - numA; // NP sestupně
                    }
                    if (a.type === 'PP' && b.type === 'PP') {
                        const numA = parseInt(a.floorCode.replace(/\D/g, '')) || 0;
                        const numB = parseInt(b.floorCode.replace(/\D/g, '')) || 0;
                        return numA - numB; // PP vzestupně
                    }

                    return 0;
                });

                const timePeriodKeys = [...new Set(currentData.map(d => {
                    if (!d.time_period) {
                        console.error('Chybějící time_period:', d);
                        return null;
                    }
                    return d.time_period.getTime();
                }))].filter(x => x !== null).sort((a, b) => a - b);

                // Získej jedinečné časové periody jako string klíče pro správné porovnání
                const timePeriodMap = new Map(timePeriodKeys.map(k => [k, new Date(k)]));

                // Převed čas na string
                const labels = timePeriodKeys.map(t => {
                    const date = timePeriodMap.get(t);
                    if (grain === 'month') {
                        return date.toLocaleDateString('cs-CZ', { year: 'numeric', month: 'short' });
                    } else if (grain === 'day') {
                        return date.toLocaleDateString('cs-CZ', { day: 'numeric', month: 'short' });
                    } else {
                        return date.toLocaleDateString('cs-CZ', { day: 'numeric', month: 'short', hour: '2-digit' });
                    }
                });

                // Zjisti režim zobrazení
                const viewMode = document.getElementById('view-mode').value;

                // Vytvoři dataset pro každou kombinaci location+metric
                const datasets = [];
                locsWithLabels.forEach((locObj, idx) => {
                    // Filtruj data pro danou location a metric
                    const locData = currentData.filter(d => d.location === locObj.loc && d.metric === locObj.metric);
                    // Vytvoř mapu pro rychlé vyhledávání
                    const locDataMap = new Map(locData.map(d => [d.time_period.getTime(), d]));

                    const baseColor = getColor(idx);

                    // MAX-AVG-MIN režim: všechny tři datasety
                    if (viewMode === 'max-avg-min') {
                        // Min - tenká čára
                        datasets.push({
                            label: `${locObj.label} MIN`,
                            data: timePeriodKeys.map(t => {
                                const rowData = locData.find(d => d.time_period.getTime() === t);
                                return rowData ? rowData.min_value : null;
                            }),
                            borderColor: baseColor,
                            borderWidth: 1,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                            pointHitRadius: 15
                        });

                        // Max - tenká čára s fill k min
                        datasets.push({
                            label: `${locObj.label} MAX`,
                            data: timePeriodKeys.map(t => {
                                const rowData = locData.find(d => d.time_period.getTime() === t);
                                return rowData ? rowData.max_value : null;
                            }),
                            borderColor: baseColor,
                            backgroundColor: baseColor + '25',
                            borderWidth: 1,
                            fill: { target: '-1' },
                            tension: 0.1,
                            pointRadius: 0,
                            pointHitRadius: 15
                        });
                    }

                    // AVG - vždy zobrazen
                    datasets.push({
                        label: `${locObj.label} AVG`,
                        data: timePeriodKeys.map(t => {
                            const rowData = locDataMap.get(t);
                            return rowData ? rowData.value : null;
                        }),
                        borderColor: baseColor,
                        backgroundColor: 'transparent',
                        borderWidth: viewMode === 'avg' ? 2 : 3,
                        tension: 0.1,
                        fill: false,
                        spanGaps: true,
                        pointRadius: grain === 'month' ? 4 : 2,
                        pointHitRadius: 15
                    });
                });

                // Znič starý graf
                if (chart) {
                    chart.destroy();
                }

                // Vytvoř nový graf
                const ctx = document.getElementById('mainChart').getContext('2d');
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    boxWidth: 12,
                                    padding: 15
                                }
                            },
                            tooltip: {
                                mode: 'point',
                                intersect: false
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: ConfigHelpers.t('time')
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: ConfigHelpers.t('temperature')
                                }
                            }
                        },
                        interaction: {
                            mode: 'point',
                            intersect: false
                        }
                    }
                });

            } catch (error) {
                showError(ConfigHelpers.t('errorLoading', {error: 'Chyba při zobrazení: ' + error.message}));
                console.error(error);
            }
        }

        // Aktualizuj záhlaví
        function updateHeader(message) {
            const grain = document.getElementById('grain').value;
            const period = document.getElementById('period').value;

            // Granularita label z configu
            const grainText = ConfigHelpers.getGranularityLabel(grain);

            // Získej vybrané sekce pro záhlaví
            const sectionCheckboxes = document.querySelectorAll('.section-cb:checked');
            const selectedSections = Array.from(sectionCheckboxes).map(cb => cb.value);
            const allSectionsCount = DATASET_CONFIG.sections.length;
            const sectionText = selectedSections.length === allSectionsCount ? ConfigHelpers.t('all') : selectedSections.join(',');

            // Získej vybrané metriky pro záhlaví
            const metricCheckboxes = document.querySelectorAll('.metric-cb:checked');
            const selectedMetrics = Array.from(metricCheckboxes).map(cb => ConfigHelpers.getMetricLabel(cb.value));
            const metricText = selectedMetrics.join(' + ');

            // Získej vybrané zdroje (generické)
            const sourceParts = [];
            const sources = DATASET_CONFIG.sources || {};

            Object.values(sources).forEach(source => {
                if (source.floors) {
                    // Hierarchický zdroj - zobraz vybrané položky
                    const selectedItems = getSourceItems(source.key);
                    if (selectedItems && selectedItems.size > 0) {
                        const items = Array.from(selectedItems).sort((a, b) => {
                            // Zachováť původní řazení (NP sestupně, PP vzestupně)
                            const typeA = a.includes('NP') ? 'NP' : 'PP';
                            const typeB = b.includes('NP') ? 'NP' : 'PP';
                            const numA = parseInt(a.replace(/\D/g, '')) || 0;
                            const numB = parseInt(b.replace(/\D/g, '')) || 0;

                            if (typeA !== typeB) return typeA === 'NP' ? -1 : 1;
                            if (typeA === 'NP') return numB - numA;
                            return numA - numB;
                        });
                        sourceParts.push(items.map(i => `${source.label} ${i}`).join(', '));
                    }
                } else {
                    // Simple zdroj
                    if (isSourceSelected(source.key)) {
                        sourceParts.push(source.label);
                    }
                }
            });

            const sourceText = sourceParts.length > 0 ? sourceParts.join(', ') : ConfigHelpers.t('none');

            let headerText = `${ConfigHelpers.t('section')} ${sectionText} • ${metricText} • ${grainText} • ${ConfigHelpers.t('period')} ${period}`;
            if (sourceText !== ConfigHelpers.t('none')) {
                headerText += ` • ${ConfigHelpers.t('source')} ${sourceText}`;
            }
            if (message) {
                headerText += ` (${message})`;
            }

            document.querySelector('.header p').textContent = headerText;
        }

        function showError(message) {
            updateHeader(`❌ ${message}`);
        }

        // Start - Inicializuj UI z configu před načtením dat
        initUIFromConfig();

        // Při změně granularity aktualizuj options period a překresli graf
        document.getElementById('grain').addEventListener('change', () => {
            updatePeriodOptions();
            updateChart();
            updateURL();
        });

        document.getElementById('period').addEventListener('change', () => {
            updateChart();
            updateURL();
        });
        document.getElementById('view-mode').addEventListener('change', () => {
            updateChart();
            updateURL();
        });

        // Při změně jazyka reload stránky s novým configem
        const languageSelect = document.getElementById('language');
        if (languageSelect) {
            languageSelect.addEventListener('change', (e) => {
                changeLanguage(e.target.value);
            });
        }

        // Export funkcí pro globální přístup z HTML onclick
        window.priorPeriod = priorPeriod;
        window.nextPeriod = nextPeriod;

        loadData();
        } // Konec initApp()

        // Spusť aplikaci - načti config a inicializuj
        loadConfig();
    </script>
</body>
</html>
