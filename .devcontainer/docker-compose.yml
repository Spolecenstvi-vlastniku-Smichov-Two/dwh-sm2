services:
  dwh-sm2-devcontainer:
    container_name: dwh-sm2-devcontainer
    build:
      context: ..
      dockerfile: .devcontainer/Dockerfile
    volumes:
      - ..:/workspace
      - ~/.config/rclone:/home/vscode/.config/rclone
      - ~/.gitconfig:/home/vscode/.gitconfig
      - ~/.ssh:/home/vscode/.ssh
      - ./db:/workspace/db
      - ./test_data:/workspace/test_data
    working_dir: /workspace
    tty: true
    stdin_open: true
    healthcheck:
      test: ["CMD", "python3", "/workspace/.devcontainer/test_environment.py"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 30s
    environment:
      - PYTHONUNBUFFERED=1
      - DBT_PROFILES_DIR=/workspace
      - INFLUX_URL=http://dwh-sm2-influxdb:8086
      - INFLUX_ORG=dev
      - INFLUX_TOKEN=devtoken
      - INFLUX_BUCKET=sensor_data
      - DUCKDB_DATABASE=/workspace/db/sm2.duckdb
      - GDRIVE_REMOTE=sm2drive
      - LOCAL_AGG_DIR=/workspace/gdrive
      - OUT_DIR=/workspace/public
    ports:
      - "8080:8080"
      - "8086:8086"
      - "9000:9000"  # DuckDB HTTP interface
    depends_on:
      dwh-sm2-influxdb:
        condition: service_healthy

  influxdb:
    image: influxdb:2.7
    container_name: dwh-sm2-influxdb
    ports:
      - "8086:8086"
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=dev
      - DOCKER_INFLUXDB_INIT_PASSWORD=devpassword
      - DOCKER_INFLUXDB_INIT_ORG=dev
      - DOCKER_INFLUXDB_INIT_BUCKET=sensor_data
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=devtoken
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8086/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  duckdb:
    image: duckdb/duckdb:latest
    container_name: dwh-sm2-duckdb
    volumes:
      - ./db:/data
    ports:
      - "9000:9000"
    command: ["duckdb", "-http", "-listen", "0.0.0.0:9000"]
